import pygame
import sys

# ================= CONFIGURAÇÕES =================
SCREEN_WIDTH = 600
SCREEN_HEIGHT = 700
BG_COLOR = (30, 30, 30)

BOARD_SIZE = 9
CELL_SIZE = SCREEN_WIDTH // BOARD_SIZE
LINE_COLOR = (200, 200, 200)

WHITE = (255, 255, 255)
PLAYER_X_COLOR = (255, 50, 50)
PLAYER_O_COLOR = (50, 50, 255)

# ================= FUNÇÕES =================
def draw_board(screen, board, scores):
    screen.fill(BG_COLOR)

    # Linhas do tabuleiro
    for i in range(BOARD_SIZE + 1):
        pygame.draw.line(screen, LINE_COLOR,
                         (i * CELL_SIZE, 0),
                         (i * CELL_SIZE, BOARD_SIZE * CELL_SIZE), 2)
        pygame.draw.line(screen, LINE_COLOR,
                         (0, i * CELL_SIZE),
                         (BOARD_SIZE * CELL_SIZE, i * CELL_SIZE), 2)

    # Símbolos
    font = pygame.font.SysFont("arial", CELL_SIZE // 2, bold=True)
    for row in range(BOARD_SIZE):
        for col in range(BOARD_SIZE):
            if board[row][col] != "":
                text = font.render(board[row][col], True,
                                   PLAYER_X_COLOR if board[row][col] == "X" else PLAYER_O_COLOR)
                screen.blit(text, (col * CELL_SIZE + CELL_SIZE//3,
                                   row * CELL_SIZE + CELL_SIZE//4))

    # Placar
    score_font = pygame.font.SysFont("arial", 28, bold=True)
    score_text = score_font.render(f"Jogador X: {scores['X']}  |  Jogador O: {scores['O']}",
                                   True, WHITE)
    screen.blit(score_text, (20, SCREEN_HEIGHT - 80))

def check_new_triples(board, player, scored_positions):
    """Retorna quantos pontos novos o jogador fez ao completar trincas"""
    new_points = 0
    new_scored = []

    # Horizontal
    for row in range(BOARD_SIZE):
        for col in range(BOARD_SIZE - 2):
            if board[row][col] == board[row][col+1] == board[row][col+2] == player:
                triple = (row, col, "H")
                if triple not in scored_positions:
                    new_points += 1
                    new_scored.append(triple)

    # Vertical
    for col in range(BOARD_SIZE):
        for row in range(BOARD_SIZE - 2):
            if board[row][col] == board[row+1][col] == board[row+2][col] == player:
                triple = (row, col, "V")
                if triple not in scored_positions:
                    new_points += 1
                    new_scored.append(triple)

    # Diagonal ↘
    for row in range(BOARD_SIZE - 2):
        for col in range(BOARD_SIZE - 2):
            if board[row][col] == board[row+1][col+1] == board[row+2][col+2] == player:
                triple = (row, col, "D1")
                if triple not in scored_positions:
                    new_points += 1
                    new_scored.append(triple)

    # Diagonal ↙
    for row in range(BOARD_SIZE - 2):
        for col in range(2, BOARD_SIZE):
            if board[row][col] == board[row+1][col-1] == board[row+2][col-2] == player:
                triple = (row, col, "D2")
                if triple not in scored_positions:
                    new_points += 1
                    new_scored.append(triple)

    return new_points, new_scored

def game_loop(screen):
    board = [["" for _ in range(BOARD_SIZE)] for _ in range(BOARD_SIZE)]
    current_player = "X"
    scores = {"X": 0, "O": 0}
    scored_positions = []  # Guarda trincas já contadas

    running = True
    while running:
        draw_board(screen, board, scores)
        pygame.display.flip()

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
                pygame.quit()
                sys.exit()

            if event.type == pygame.MOUSEBUTTONDOWN:
                x, y = pygame.mouse.get_pos()
                col = x // CELL_SIZE
                row = y // CELL_SIZE

                if row < BOARD_SIZE and col < BOARD_SIZE:
                    if board[row][col] == "":
                        board[row][col] = current_player
                        # Checar novos pontos
                        gained, new_scored = check_new_triples(board, current_player, scored_positions)
                        scores[current_player] += gained
                        scored_positions.extend(new_scored)
                        # Trocar jogador
                        current_player = "O" if current_player == "X" else "X"

# ================= MAIN =================
def main():
    pygame.init()
    screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
    pygame.display.set_caption("Jogo da Velha 9x9 com Placar")
    game_loop(screen)

if __name__ == "__main__":
    main()
